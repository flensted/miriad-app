# Deploy to Production - Manual trigger with confirmation
#
# Deploys all components:
# - Backend API → AWS Lambda (SAM)
# - Frontend → Vercel
# - Agent Container → Fly.io Registry (amd64)
# - Tunnel Server → AWS Fargate (arm64)
#
# Fly.io is now the container runtime for agents (replacing ECS/Fargate).

name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy-prod" to confirm'
        required: true
        type: string

concurrency:
  group: deploy-prod
  cancel-in-progress: false

permissions:
  contents: write

env:
  AWS_REGION: us-east-1

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Verify confirmation
        if: github.event.inputs.confirm != 'deploy-prod'
        run: |
          echo "::error::You must type 'deploy-prod' to confirm."
          exit 1

  backend:
    name: Backend API
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: backend/pnpm-lock.yaml
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: aws-actions/setup-sam@v2
      - name: Install and build
        working-directory: backend
        run: pnpm install --frozen-lockfile && pnpm build
      - name: Run database migrations
        working-directory: backend
        env:
          PLANETSCALE_URL: ${{ secrets.PROD_PLANETSCALE_URL }}
        run: pnpm --filter @cast/storage migrate
      - name: Build Lambda bundle
        working-directory: backend/deploy
        run: node build.mjs
      - name: Install esbuild for SAM
        run: npm install -g esbuild
      - name: SAM Build
        working-directory: backend/deploy
        run: sam build
      - name: SAM Deploy
        working-directory: backend/deploy
        env:
          # Pass secrets as env vars to avoid shell parsing issues
          PARAM_PLANETSCALE_URL: ${{ secrets.PROD_PLANETSCALE_URL }}
          PARAM_ANTHROPIC_API_KEY: ${{ secrets.PROD_ANTHROPIC_API_KEY }}
          PARAM_JWT_SECRET: ${{ secrets.PROD_JWT_SECRET }}
          PARAM_SECRET_KEY: ${{ secrets.PROD_SECRET_KEY }}
          PARAM_WORKOS_API_KEY: ${{ secrets.PROD_WORKOS_API_KEY }}
          PARAM_WORKOS_CLIENT_ID: ${{ secrets.PROD_WORKOS_CLIENT_ID }}
          PARAM_GITHUB_CLIENT_ID: ${{ secrets.PROD_GITHUB_CLIENT_ID }}
          PARAM_GITHUB_CLIENT_SECRET: ${{ secrets.PROD_GITHUB_CLIENT_SECRET }}
          PARAM_FLY_API_TOKEN: ${{ secrets.PROD_FLY_API_TOKEN }}
          PARAM_FLY_APP_NAME: ${{ secrets.PROD_FLY_APP_NAME }}
          PARAM_CONTAINER_SECRET: ${{ secrets.PROD_CONTAINER_SECRET }}
        run: |
          # Write samconfig.toml to bypass SAM CLI parameter parsing entirely
          # This avoids the space-truncation issue with FlyV1 tokens
          cat > samconfig.toml << EOF
          version = 0.1
          [default.deploy.parameters]
          stack_name = "cast-backend-prod"
          capabilities = "CAPABILITY_IAM CAPABILITY_NAMED_IAM"
          confirm_changeset = false
          fail_on_empty_changeset = false
          resolve_s3 = true
          s3_prefix = "cast-backend"
          region = "${{ env.AWS_REGION }}"
          parameter_overrides = [
            "Stage=prod",
            "PlanetScaleUrl=${PARAM_PLANETSCALE_URL}",
            "AnthropicApiKey=${PARAM_ANTHROPIC_API_KEY}",
            "JwtSecret=${PARAM_JWT_SECRET}",
            "SecretKey=${PARAM_SECRET_KEY}",
            "AuthMode=workos",
            "WorkOsApiKey=${PARAM_WORKOS_API_KEY}",
            "WorkOsClientId=${PARAM_WORKOS_CLIENT_ID}",
            "WorkOsRedirectUri=https://api.miriad.tech/auth/callback",
            "FrontendUrl=https://miriad.tech",
            "CastApiUrl=https://api.miriad.tech",
            "CastWsUrl=wss://ws.miriad.tech",
            "GitHubClientId=${PARAM_GITHUB_CLIENT_ID}",
            "GitHubClientSecret=${PARAM_GITHUB_CLIENT_SECRET}",
            "TunnelServerUrl=https://tunnel.miriad.site",
            "AgentImageUri=registry.fly.io/${PARAM_FLY_APP_NAME}:latest",
            "FlyApiToken=\"${PARAM_FLY_API_TOKEN}\"",
            "FlyAppName=${PARAM_FLY_APP_NAME}",
            "FlyRegion=iad",
            "SpaceId=default",
            "ContainerSecret=${PARAM_CONTAINER_SECRET}",
            "MiriadRuntimeMode=fly",
            "DeployTimestamp=${{ github.run_id }}-${{ github.run_number }}"
          ]
          EOF
          cat samconfig.toml
          sam deploy

  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.PROD_VERCEL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml
      - run: npm install -g vercel
      - working-directory: frontend
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      - working-directory: frontend
        run: |
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VITE_BACKEND_URL: https://api.miriad.tech
          VITE_WS_URL: wss://ws.miriad.tech
          VITE_AUTH_MODE: workos
          VITE_TUNNEL_DOMAIN: miriad.site

  container:
    name: Agent Container (Fly.io)
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Fly CLI
        run: curl -L https://fly.io/install.sh | sh && echo "$HOME/.fly/bin" >> $GITHUB_PATH

      - name: Authenticate with Fly
        run: ~/.fly/bin/fly auth docker
        env:
          FLY_API_TOKEN: ${{ secrets.PROD_FLY_API_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      # Build and push Miriad Cloud container to Fly.io registry (MUST be linux/amd64 for Fly Machines)
      # Multi-stage build compiles local-runtime from source
      - uses: docker/build-push-action@v5
        with:
          context: .
          file: agents/miriad-cloud/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            registry.fly.io/${{ secrets.PROD_FLY_APP_NAME }}:latest
            registry.fly.io/${{ secrets.PROD_FLY_APP_NAME }}:sha-${{ github.sha }}
            registry.fly.io/${{ secrets.PROD_FLY_APP_NAME }}:prod-${{ github.run_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  tunnel:
    name: Tunnel Server (Fly.io)
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Install Fly CLI
        run: curl -L https://fly.io/install.sh | sh && echo "$HOME/.fly/bin" >> $GITHUB_PATH

      - name: Set Fly secrets
        run: ~/.fly/bin/fly secrets set CAST_CONTAINER_SECRET="${{ secrets.PROD_CONTAINER_SECRET }}" -a cast-tunnel-prod
        env:
          FLY_API_TOKEN: ${{ secrets.PROD_TUNNEL_FLY_API_TOKEN }}

      - name: Deploy to Fly.io
        working-directory: backend/packages/tunnel-server
        run: ~/.fly/bin/fly deploy --config fly.prod.toml --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.PROD_TUNNEL_FLY_API_TOKEN }}

  tag:
    name: Tag Release
    runs-on: ubuntu-latest
    needs: [backend, frontend, container, tunnel]
    steps:
      - uses: actions/checkout@v4
      - run: |
          TAG="prod-$(date +%Y%m%d-%H%M%S)"
          git tag "$TAG"
          git push origin "$TAG"
          echo "Created tag: $TAG" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend, container, tunnel, tag]
    if: always()
    steps:
      - run: |
          echo "## Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container (Fly.io) | ${{ needs.container.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tunnel | ${{ needs.tunnel.result }} |" >> $GITHUB_STEP_SUMMARY
